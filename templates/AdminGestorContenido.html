<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Contenido</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            min-height: 100vh;
            background-color: #0707a1;
            color: #2c2c2c;
        }

        /* Sidebar lateral */
        .sidebar {
            width: 240px;
            background-color: #ffffff;
            border-right: 1px solid #ddd;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: start;
        }

        .sidebar h2 {
            font-size: 1.8rem;
            color: #a66cff;
            margin-bottom: 2rem;
        }

        .sidebar ul {
            list-style: none;
            width: 100%;
        }

        .sidebar ul li {
            margin-bottom: 1.2rem;
        }

        .sidebar ul li a {
            text-decoration: none;
            color: #444;
            font-size: 1rem;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }

        .sidebar ul li a:hover {
            color: #a66cff;
            font-weight: bold;
        }

        .sidebar button {
            margin-top: auto;
            background-color: transparent;
            border: none;
            color: #a66cff;
            font-size: 1rem;
            cursor: pointer;
            padding: 1rem 0;
        }

        /* Contenedor principal */
        .content {
            flex: 1;
            padding: 3rem;
        }

        /* Tarjeta de contenido más descargado */
        .tarjeta-panel {
            background-color: #e5d5ff;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tarjeta-panel h1 {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: #3c003c;
            margin-bottom: 1rem;
        }

        .tarjeta-panel h2 {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #3c003c;
            margin-bottom: 2rem;
        }

        /* Lista de contenido */
        .contenido-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Estilo para los botones con formato de item-contenido */
        .item-contenido {
            background-color: #fff;
            border: none;
            border-radius: 12px;
            padding: 0.8rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, background-color 0.3s;
            cursor: pointer;
            text-align: left;
            width: 100%;
            margin: 1rem;
        }

        .item-contenido:hover {
            transform: scale(1.02);
            background-color: #f0f0f0;
        }

        .item-contenido .info {
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
        }

        .item-contenido .info strong {
            font-weight: bold;
            color: #333;
        }

        .item-contenido .info span {
            font-size: 0.8rem;
            color: #777;
        }

        /* Eliminar el estilo predeterminado de los botones */
        button.item-contenido {
            all: unset;
            /* Resetea todos los estilos predeterminados del botón */
            display: flex;
            align-items: center;
            width: 100%;
        }

        /* Estilo general para los formularios */
        .form-container {
            margin-top: 2rem;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-container h3 {
            text-align: center;
            font-size: 1.5rem;
            color: #3c003c;
            margin-bottom: 1.5rem;
        }

        .form-container form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .form-container form label {
            font-size: 1rem;
            color: #3c003c;
            font-weight: bold;
        }

        .form-container form input,
        .form-container form select {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #f9f9f9;
            transition: border-color 0.3s;
        }

        .form-container form input:focus,
        .form-container form select:focus {
            border-color: #a66cff;
            outline: none;
        }

        .form-container form button {
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            background-color: #a66cff;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .form-container form button:hover {
            background-color: #8b5fcf;
        }

        .back-button {
            margin-top: 1rem;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            background-color: #ccc;
            color: #333;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: #bbb;
        }

        .content {
            flex: 1;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .options {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        .table-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .table-container h3 {
            text-align: center;
            font-size: 1.5rem;
            color: #3c003c;
            margin-bottom: 1rem;
        }

        .filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filters label {
            font-size: 1rem;
            color: #3c003c;
            font-weight: bold;
        }

        .filters select,
        .filters button {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #f9f9f9;
            cursor: pointer;
        }

        .filters button {
            background-color: #a66cff;
            color: #fff;
            transition: background-color 0.3s;
        }

        .filters button:hover {
            background-color: #8b5fcf;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        table th,
        table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #a66cff;
            color: #fff;
        }

        table tr:hover {
            background-color: #f9f9f9;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>Fauget</h2>
        <ul>
            <li><a href="/AdminPaginaPrincipal">Administrador</a></li>
            <li><a href="/AdminGestorContenido">Gestionar contenido</a></li>
            <li><a href="/AdminGestorCategorias">Gestionar categoría</a></li>
            <li><a href="/AdminGestorPromociones">Gestionar promociones</a></li>
            <li><a href="/CargarSaldo">Cargar saldo a usuario</a></li>
        </ul>
        <button onclick="window.location.href='/logout'">Cerrar sesión</button>
    </div>

    <div class="content">
        <div class="tarjeta-panel">
            <h1>Gestión de Contenido</h1>
            <h2>Seleccione una opción</h2>
            <div class="options" id="main-options">
                <button id="add-content" class="item-contenido">
                    <div class="info">
                        <strong>Agregar contenido</strong>
                        <span>Crear una nueva contenido</span>
                    </div>
                </button>
                <button id="edit-content" class="item-contenido">
                    <div class="info">
                        <strong>Editar contenido</strong>
                        <span>Modificar una contenido existente</span>
                    </div>
                </button>
                <button id="delete-content" class="item-contenido">
                    <div class="info">
                        <strong>Eliminar contenido</strong>
                        <span>Eliminar una contenido existente</span>
                    </div>
                </button>
            </div>

            <div class="form-container" id="form-container" style="display: none;">
                <!-- Formulario para Agregar Contenido -->
                <div id="add-content-form" style="display: none;">
                    <h3>Agregar Contenido</h3>
                    <p id="duplicate-warning"
                        style="color: red; display: none; text-align: center; margin-bottom: 1rem;">
                        Ya existe un contenido con ese nombre. Por favor, elija otro nombre.
                    </p>
                    <form id="content-form" enctype="multipart/form-data">
                        <label for="content-name">Nombre del Contenido</label>
                        <input type="text" id="content-name" name="nombre" placeholder="Ingrese el nombre del contenido"
                            required>

                        <label for="content-author">Autor(es)</label>
                        <input type="text" id="content-author" name="autor"
                            placeholder="Ingrese los autores separados por coma" required>

                        <label for="content-type">Tipo</label>
                        <select id="content-type" name="tipo" required>
                            <option value="">Seleccione el tipo</option>
                            <option value="sonido">sonido</option>
                            <option value="imagen">imagen</option>
                            <option value="video">video</option>
                        </select>

                        <label for="content-category">Categoría</label>
                        <select id="content-category" name="categoria" required>
                            <option value="">Seleccione una categoría</option>
                        </select>

                        <label for="content-file">Archivo (máx. 100MB)</label>
                        <input type="file" id="content-file" name="archivo"
                            accept=".jpg,.jpeg,.png,.mp3,.flac,.wav,.mp4" required>
                        <p id="file-error-message" style="color: red; display: none;">Archivo no válido o excede el
                            límite de 100MB.</p>

                        <label for="content-description">Descripción</label>
                        <textarea id="content-description" name="descripcion" placeholder="Ingrese una descripción"
                            required></textarea>

                        <label for="content-price">Precio (Nuevos Soles)</label>
                        <input type="number" id="content-price" name="precio" placeholder="Ingrese el precio" min="0"
                            step="0.01" required>

                        <button type="submit">Guardar</button>
                    </form>
                    <button class="back-button">Atrás</button>
                </div>


                <!-- Formulario para Editar Contenido -->
                <div id="edit-content-form" style="display: none;">
                    <h3>Editar Contenido</h3>
                    <form id="edit-content-search-form"
                        style="margin-bottom: 2rem; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <label for="edit-content-search" style="font-weight: bold;">Ingrese el <b>ID</b> o <b>Nombre</b>
                            del contenido a editar</label>
                        <input type="text" id="edit-content-search" name="busqueda"
                            placeholder="ID o Nombre (sensible a mayúsculas/minúsculas)" required
                            style="width: 80%; max-width: 350px;">
                        <button type="submit" style="width: 50%; max-width: 200px;">Buscar</button>
                        <p id="edit-content-search-error"
                            style="color: red; display: none; text-align: center; margin-top: 1rem;"></p>
                    </form>
                    <form id="edit-content-fields-form"
                        style="display: none; grid-template-columns: 1fr 1fr; gap: 1.2rem; max-width: 500px; margin: 0 auto;">
                        <div style="display: flex; flex-direction: column;">
                            <label for="edit-content-nombre" style="font-weight: bold;">Nombre</label>
                            <input type="text" id="edit-content-nombre" name="nombre" required>
                            <p id="edit-content-duplicate-error"
                                style="color: red; display: none; margin-top: 0.5rem; margin-bottom: 0;"></p>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="edit-content-descripcion" style="font-weight: bold;">Descripción</label>
                            <textarea id="edit-content-descripcion" name="descripcion" maxlength="300" required
                                style="resize: vertical; min-height: 40px;"></textarea>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="edit-content-precio" style="font-weight: bold;">Precio (Nuevos Soles)</label>
                            <input type="number" id="edit-content-precio" name="precio" min="0" step="0.01" required>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="edit-content-autor" style="font-weight: bold;">Autor(es)</label>
                            <input type="text" id="edit-content-autor" name="autor" required>
                        </div>
                        <div style="grid-column: 1 / -1; display: flex; justify-content: center;">
                            <button type="submit" style="width: 60%; max-width: 220px;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>

                <!-- Formulario para Eliminar Contenido -->
                <div id="delete-content-form" style="display: none;">
                    <h3>Eliminar Contenido</h3>
                    <form id="delete-content-search-form">
                        <label for="delete-content-search" style="font-weight: bold;">Ingrese el ID o Nombre del
                            contenido a eliminar</label>
                        <input type="text" id="delete-content-search" name="busqueda"
                            placeholder="ID o Nombre (sensible a mayúsculas/minúsculas)" required>
                        <button type="submit">Buscar</button>
                        <p id="delete-content-search-error"
                            style="color: red; display: none; text-align: center; margin-top: 1rem;"></p>
                    </form>
                    <form id="delete-content-fields-form" style="display: none;">
                        <label for="delete-content-nombre" style="font-weight: bold;">Nombre del Contenido</label>
                        <input type="text" id="delete-content-nombre" disabled>

                        <label for="delete-content-autor" style="font-weight: bold;">Autor(es)</label>
                        <input type="text" id="delete-content-autor" disabled>

                        <label for="delete-content-descripcion" style="font-weight: bold;">Descripción</label>
                        <textarea id="delete-content-descripcion" disabled></textarea>

                        <label for="delete-content-precio" style="font-weight: bold;">Precio (Nuevos Soles)</label>
                        <input type="number" id="delete-content-precio" disabled>

                        <button type="button" id="delete-content-confirm-btn" style="
                background: #e74c3c;
                color: #fff;
                font-weight: bold;
                border: none;
                border-radius: 8px;
                padding: 0.8rem;
                font-size: 1rem;
                margin-top: 1rem;
                width: 100%;
                transition: background 0.3s;
                cursor: pointer;
            " onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">Eliminar
                            Contenido</button>
                    </form>
                    <button class="back-button">Atrás</button>
                </div>

                <!-- Modal de confirmación -->
                <div id="delete-confirm-modal"
                    style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
                    <div
                        style="background:#fff; padding:2rem 3rem; border-radius:12px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                        <h2 style="color: #e74c3c;">¿Está seguro de eliminar este contenido?</h2>
                        <p>El contenido será eliminado de la cuenta de los usuarios que lo posean y se les enviará una
                            notificación de disculpa.</p>
                        <button id="delete-confirm-yes"
                            style="margin:1rem; background:#e74c3c; color:#fff;">Eliminar</button>
                        <button id="delete-confirm-no" style="margin:1rem;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div id="success-modal"
                style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
                <div
                    style="background:#fff; padding:2rem 3rem; border-radius:12px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                    <h2 id="success-modal-message" style="color: #3c003c;">¡Operación exitosa!</h2>
                    <button id="success-ok"
                        style="margin-top:1.5rem; padding:0.7rem 2rem; border:none; border-radius:8px; background:#a66cff; color:#fff; font-size:1.1rem; font-weight:bold; cursor:pointer;">OK</button>
                </div>
            </div>
            <div id="delete-confirm-modal"
                style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
                <div
                    style="background:#fff; padding:2rem 3rem; border-radius:12px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                    <h2 style="color: #e74c3c;">¿Está seguro de eliminar este contenido?</h2>
                    <p>El contenido será eliminado de la cuenta de los usuarios que lo posean y se les enviará una
                        notificación de disculpa.</p>
                    <button id="delete-confirm-yes"
                        style="margin:1rem; background:#e74c3c; color:#fff;">Eliminar</button>
                    <button id="delete-confirm-no" style="margin:1rem;">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Tabla de Contenidos -->
        <div class="table-container">
            <h3>Lista de Contenidos</h3>
            <div class="filters">
                <input type="text" id="search-input" placeholder="Buscar por nombre o autor">
                <button id="sort-name-btn">Ordenar por Nombre (A-Z)</button>
            </div>
            <table id="content-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Autor(es)</th>
                        <th>Descripción</th>
                        <th>Categoría</th>
                        <th>Precio</th>
                        <th>Promoción (%)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas se llenarán dinámicamente con JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const mainOptions = document.getElementById("main-options");
            const formContainer = document.getElementById("form-container");
            const addContentForm = document.getElementById("add-content-form");
            const editContentForm = document.getElementById("edit-content-form");
            const contentTableBody = document.querySelector("#content-table tbody");
            const validateContentBtn = document.getElementById("validate-content-btn");

            // Botones principales
            const addContentButton = document.getElementById("add-content");
            const editContentButton = document.getElementById("edit-content");
            const deleteContentButton = document.getElementById("delete-content");

            // Botones "Atrás"
            const backButtons = document.querySelectorAll(".back-button");

            // Mostrar el formulario correspondiente
            addContentButton.addEventListener("click", () => {
                mainOptions.style.display = "none";
                formContainer.style.display = "block";
                addContentForm.style.display = "block";
                editContentForm.style.display = "none";
                deleteContentForm.style.display = "none";
            });

            // Mostrar solo el campo de búsqueda al abrir el formulario de editar contenido
            editContentButton.addEventListener("click", () => {
                mainOptions.style.display = "none";
                formContainer.style.display = "block";
                addContentForm.style.display = "none";
                editContentForm.style.display = "block";
                deleteContentForm.style.display = "none";
                editContentFieldsForm.style.display = "none";
                editContentSearchForm.reset();
                editContentFieldsForm.reset();
            });

            deleteContentButton.addEventListener("click", () => {
                mainOptions.style.display = "none";
                formContainer.style.display = "block";
                deleteContentForm.style.display = "block";
            });

            // Manejar el botón "Atrás"
            backButtons.forEach(button => {
                button.addEventListener("click", () => {
                    const confirmBack = confirm("¿Está seguro de que desea cancelar la operación y regresar?");
                    if (confirmBack) {
                        formContainer.style.display = "none";
                        addContentForm.style.display = "none";
                        editContentForm.style.display = "none";
                        deleteContentForm.style.display = "none";
                        mainOptions.style.display = "block";
                    }
                });
            });

            const contentForm = document.getElementById("content-form");
            const contentCategorySelect = document.getElementById("content-category");
            const fileInput = document.getElementById("content-file");
            const fileErrorMessage = document.getElementById("file-error-message");
            const successModal = document.getElementById("success-modal");
            const successModalMessage = document.getElementById("success-modal-message");
            const successOk = document.getElementById("success-ok");
            successOk.addEventListener("click", () => {
                successModal.style.display = "none";
                formContainer.style.display = "none";
                addContentForm.style.display = "none";
                editContentForm.style.display = "none";
                deleteContentForm.style.display = "none";
                mainOptions.style.display = "block";
                loadContents();
            });
            // Agregar contenido
            async function obtenerCategoriasPorPadre(tipo) {
                if (!tipo) {
                    contentCategorySelect.innerHTML = '<option value="">Seleccione una categoría</option>';
                    return;
                }
                try {
                    const response = await fetch(`/getCategoriasHijas?padre=${encodeURIComponent(tipo)}`);
                    const categorias = await response.json();

                    // Función recursiva para agregar subcategorías (sin prefijo "--")
                    async function agregarOpciones(categorias) {
                        for (const cat of categorias) {
                            contentCategorySelect.innerHTML += `<option value="${cat.nombre}">${cat.nombre}</option>`;
                            // Buscar subcategorías de esta categoría
                            const subResp = await fetch(`/getCategoriasHijas?padre=${encodeURIComponent(cat.nombre)}`);
                            const subcats = await subResp.json();
                            if (subcats.length > 0) {
                                await agregarOpciones(subcats);
                            }
                        }
                    }

                    // Limpiar y agregar opciones
                    contentCategorySelect.innerHTML = '<option value="">Seleccione una categoría</option>';
                    await agregarOpciones(categorias);

                } catch (error) {
                    contentCategorySelect.innerHTML = '<option value="">Error al cargar categorías</option>';
                }
            }
            const contentTypeSelect = document.getElementById("content-type");
            contentTypeSelect.addEventListener("change", function () {
                const tipoSeleccionado = contentTypeSelect.value;
                obtenerCategoriasPorPadre(tipoSeleccionado);

                // Cambiar el accept del input de archivo según el tipo
                if (tipoSeleccionado === "imagen") {
                    fileInput.accept = ".jpg,.jpeg,.png";
                } else if (tipoSeleccionado === "sonido") {
                    fileInput.accept = ".mp3,.flac,.wav";
                } else if (tipoSeleccionado === "video") {
                    fileInput.accept = ".mp4";
                } else {
                    fileInput.accept = "";
                }
                fileInput.value = "";
            });
            contentCategorySelect.innerHTML = '<option value="">Seleccione una categoría</option>';

            const duplicateWarning = document.getElementById("duplicate-warning");

            contentForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                // Limpiar mensajes previos
                duplicateWarning.style.display = "none";
                fileErrorMessage.style.display = "none";

                // Validaciones
                const nombre = document.getElementById("content-name").value.trim();
                const autor = document.getElementById("content-author").value.trim();
                const descripcion = document.getElementById("content-description").value.trim();
                const precio = parseFloat(document.getElementById("content-price").value);
                const categoria = contentCategorySelect.value;
                const tipo = contentTypeSelect.value;
                const file = fileInput.files[0];

                // Nombre: 1-100 caracteres alfanuméricos
                if (!/^[A-Za-z0-9_\-.,;áéíóúÁÉÍÓÚñÑ ]{1,100}$/.test(nombre)) {
                    duplicateWarning.textContent = "Nombre: Cadena de 1 a 100 caracteres alfanuméricos.";
                    duplicateWarning.style.display = "block";
                    return;
                }

                // Autor: 1-100 caracteres alfanuméricos
                if (!/^[A-Za-z0-9_\-.,;áéíóúÁÉÍÓÚñÑ ]{1,100}$/.test(autor)) {
                    duplicateWarning.textContent = "Autor: Cadena de 1 a 100 caracteres alfanuméricos.";
                    duplicateWarning.style.display = "block";
                    return;
                }

                // Descripción: 1-300 caracteres alfanuméricos
                if (!/^[A-Za-z0-9_\-.,;áéíóúÁÉÍÓÚñÑ ]{1,300}$/.test(descripcion)) {
                    duplicateWarning.textContent = "Descripción: Cadena de 1 a 300 caracteres alfanuméricos.";
                    duplicateWarning.style.display = "block";
                    return;
                }

                // Precio: mayor a 0.00
                if (isNaN(precio) || precio <= 0) {
                    duplicateWarning.textContent = "Precio: Debe ser un número mayor a 0.00.";
                    duplicateWarning.style.display = "block";
                    return;
                }

                // Categoría: debe estar seleccionada
                if (!categoria) {
                    duplicateWarning.textContent = "Debe seleccionar una categoría.";
                    duplicateWarning.style.display = "block";
                    return;
                }

                // Tipo: debe estar seleccionado
                if (!tipo) {
                    duplicateWarning.textContent = "Debe seleccionar un tipo de contenido.";
                    duplicateWarning.style.display = "block";
                    return;
                }

                // Archivo: extensión y tamaño
                if (!file) {
                    fileErrorMessage.textContent = "Debe seleccionar un archivo.";
                    fileErrorMessage.style.display = "block";
                    return;
                }
                const extensionesPermitidas = ['jpg', 'jpeg', 'png', 'mp3', 'flac', 'wav', 'mp4'];
                const extension = file.name.split('.').pop().toLowerCase();
                if (!extensionesPermitidas.includes(extension)) {
                    fileErrorMessage.textContent = "Archivo: Formato no permitido (jpg, png, mp3, mp4, flac, wav).";
                    fileErrorMessage.style.display = "block";
                    return;
                }
                if (file.size > 100 * 1024 * 1024) {
                    fileErrorMessage.textContent = "Archivo: El archivo excede el límite de 100MB.";
                    fileErrorMessage.style.display = "block";
                    return;
                }

                // Si todo está bien, ocultar mensajes de error
                duplicateWarning.style.display = "none";
                // Validar extensión y mime
                const nombreArchivo = file.name;

                const mime = file.type;


                const mimesPermitidos = [
                    'image/jpeg', 'image/png',
                    'audio/mpeg', 'audio/flac', 'audio/wav',
                    'video/mp4'
                ];

                if (!extensionesPermitidas.includes(extension) || !mimesPermitidos.includes(mime)) {
                    fileErrorMessage.textContent = "Formato de archivo no permitido.";
                    fileErrorMessage.style.display = "block";
                    return;
                }
                fileErrorMessage.style.display = "none";

                // Validar nombre duplicado antes de continuar
                const existe = await fetch(`/existeContenido?nombre=${encodeURIComponent(nombre)}`)
                    .then(res => res.json())
                    .then(data => data.existe);
                alert("Validando contenido...");
                if (existe) {
                    duplicateWarning.style.display = "block";
                    return;
                } else {
                    duplicateWarning.style.display = "none";
                }
                alert("Contenido validado correctamente. Procediendo a agregar...");
                // Crear FormData y agregar campos
                const formData = new FormData(contentForm);
                formData.append("extension", extension);
                formData.append("mime", mime);
                alert("El contenido se está agregando, por favor espere...");
                try {
                    const response = await fetch('/agregarContenido', {
                        method: 'POST',
                        body: formData
                    });
                    if (response.ok) {
                        successModalMessage.textContent = "¡Contenido agregado correctamente!";
                        successModal.style.display = "flex";
                        contentForm.reset();
                    } else {
                        const errorData = await response.json();
                        alert(errorData.error || "Error al agregar el contenido.");
                    }
                } catch (error) {
                    alert("Ocurrió un error al agregar el contenido.");
                }
            });
            // Editar contenido
            const editContentFormDiv = document.getElementById("edit-content-form");
            const editContentSearchForm = document.getElementById("edit-content-search-form");
            const editContentFieldsForm = document.getElementById("edit-content-fields-form");
            const editContentSearchInput = document.getElementById("edit-content-search");
            const editContentSearchError = document.getElementById("edit-content-search-error");
            const editContentNombre = document.getElementById("edit-content-nombre");
            const editContentDescripcion = document.getElementById("edit-content-descripcion");
            const editContentPrecio = document.getElementById("edit-content-precio");
            const editContentAutor = document.getElementById("edit-content-autor");
            const editContentDuplicateError = document.getElementById("edit-content-duplicate-error");

            let contenidoIdActual = null;
            let nombreOriginal = null;

            // Mostrar formulario de búsqueda al editar
            editContentButton.addEventListener("click", () => {
                mainOptions.style.display = "none";
                formContainer.style.display = "block";
                addContentForm.style.display = "none";
                editContentFormDiv.style.display = "block";
                deleteContentForm.style.display = "none";
                editContentSearchForm.reset();
                editContentFieldsForm.reset();
                editContentFieldsForm.style.display = "none";
                editContentSearchError.style.display = "none";
                editContentDuplicateError.style.display = "none";
            });

            // Buscar contenido por ID o nombre
            editContentSearchForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const busqueda = editContentSearchInput.value.trim();
                editContentSearchError.style.display = "none";
                editContentFieldsForm.style.display = "none";
                editContentDuplicateError.style.display = "none";
                if (!busqueda) return;

                // Buscar por ID 
                let contenido = null;
                try {
                    const res = await fetch(`/getContenidoUnique?busqueda=${encodeURIComponent(busqueda)}`);
                    if (res.ok) {
                        contenido = await res.json();
                    }
                } catch { }

                if (busqueda.length >= 100) {
                    editContentSearchError.textContent = "La cadena no puede tener mas de 100 caracteres.";
                    editContentSearchError.style.display = "block";
                    return;
                }
                else if (!contenido || !contenido.id) {
                    editContentSearchError.textContent = "No se encontró ningún contenido con ese ID/Nombre. Considerar mayúsculas/minúsculas.";
                    editContentSearchError.style.display = "block";
                    return;
                }
                // Llenar campos
                contenidoIdActual = contenido.id;
                nombreOriginal = contenido.nombre;
                editContentNombre.value = contenido.nombre;
                editContentDescripcion.value = contenido.descripcion;
                editContentPrecio.value = contenido.precio;
                editContentAutor.value = contenido.autor;
                editContentFieldsForm.style.display = "block";
            });

            // Validar nombre duplicado en tiempo real
            editContentNombre.addEventListener("input", async () => {
                const nuevoNombre = editContentNombre.value.trim();
                editContentDuplicateError.style.display = "none";
                if (!nuevoNombre) return;
                if (nuevoNombre === nombreOriginal) {
                    // Si el nombre no ha cambiado, no mostrar error
                    editContentDuplicateError.style.display = "none";
                    return;
                }
                // Verificar si ya existe otro contenido con ese nombre (que no sea el actual)
                const data = await fetch(`/getContenidoUnique?busqueda=${encodeURIComponent(nuevoNombre)}`)
                    .then(res => res.json());
                const existe = data && data.id && data.id !== contenidoIdActual;
                if (existe) {
                    editContentDuplicateError.textContent = "Ya existe otro contenido con ese nombre. Corrija antes de guardar.";
                    editContentDuplicateError.style.display = "block";
                }
            });

            // Guardar cambios
            editContentFieldsForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const nuevoNombre = editContentNombre.value.trim();
                if (editContentDuplicateError.style.display === "block") return;
                const descripcion = editContentDescripcion.value.trim();
                const precio = editContentPrecio.value;
                const autor = editContentAutor.value.trim();

                // Enviar actualización
                try {
                    const response = await fetch('/editarContenido', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: contenidoIdActual,
                            nombre: nuevoNombre,
                            descripcion,
                            precio,
                            autor
                        })
                    });
                    if (response.ok) {
                        successModalMessage.textContent = "¡Contenido editado correctamente!";
                        successModal.style.display = "flex";
                    } else {
                        const errorData = await response.json();
                        editContentDuplicateError.textContent = errorData.error || "Error al editar el contenido.";
                        editContentDuplicateError.style.display = "block";
                    }
                } catch {
                    editContentDuplicateError.textContent = "Error al conectar con el servidor.";
                    editContentDuplicateError.style.display = "block";
                }
            });

            // Referencias
            const deleteContentForm = document.getElementById("delete-content-form");
            const deleteContentSearchForm = document.getElementById("delete-content-search-form");
            const deleteContentFieldsForm = document.getElementById("delete-content-fields-form");
            const deleteContentSearchInput = document.getElementById("delete-content-search");
            const deleteContentSearchError = document.getElementById("delete-content-search-error");
            const deleteContentNombre = document.getElementById("delete-content-nombre");
            const deleteContentDescripcion = document.getElementById("delete-content-descripcion");
            const deleteContentPrecio = document.getElementById("delete-content-precio");
            const deleteContentAutor = document.getElementById("delete-content-autor");
            const deleteContentConfirmBtn = document.getElementById("delete-content-confirm-btn");
            const deleteConfirmModal = document.getElementById("delete-confirm-modal");
            const deleteConfirmYes = document.getElementById("delete-confirm-yes");
            const deleteConfirmNo = document.getElementById("delete-confirm-no");

            let contenidoIdEliminar = null;

            // Mostrar solo el campo de búsqueda al abrir el formulario de eliminar contenido
            deleteContentButton.addEventListener("click", () => {
                mainOptions.style.display = "none";
                formContainer.style.display = "block";
                addContentForm.style.display = "none";
                editContentForm.style.display = "none";
                deleteContentForm.style.display = "block";
                deleteContentFieldsForm.style.display = "none";
                deleteContentSearchForm.reset();
                deleteContentFieldsForm.reset();
                deleteContentSearchError.style.display = "none";
            });

            // Buscar contenido por ID o nombre
            deleteContentSearchForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const busqueda = deleteContentSearchInput.value.trim();
                deleteContentSearchError.style.display = "none";
                deleteContentFieldsForm.style.display = "none";
                if (!busqueda) return;

                let contenido = null;
                try {
                    const res = await fetch(`/getContenidoUnique?busqueda=${encodeURIComponent(busqueda)}`);
                    if (res.ok) contenido = await res.json();
                } catch { }
                if (!contenido || !contenido.id) {
                    deleteContentSearchError.textContent = "No se encontró ningún contenido con ese ID o nombre.";
                    deleteContentSearchError.style.display = "block";
                    return;
                }
                // Llenar campos solo lectura
                contenidoIdEliminar = contenido.id;
                deleteContentNombre.value = contenido.nombre;
                deleteContentDescripcion.value = contenido.descripcion;
                deleteContentPrecio.value = contenido.precio;
                deleteContentAutor.value = contenido.autor;
                deleteContentFieldsForm.style.display = "block";
            });

            // Mostrar modal de confirmación al hacer clic en eliminar
            deleteContentConfirmBtn.addEventListener("click", () => {
                deleteConfirmModal.style.display = "flex";
            });

            // Cancelar eliminación
            deleteConfirmNo.addEventListener("click", () => {
                deleteConfirmModal.style.display = "none";
            });

            // Confirmar eliminación
            deleteConfirmYes.addEventListener("click", async () => {
                deleteConfirmModal.style.display = "none";
                try {
                    const response = await fetch('/eliminarContenido', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: contenidoIdEliminar })
                    });
                    if (response.ok) {
                        successModalMessage.textContent = "¡Contenido eliminado correctamente!";
                        successModal.style.display = "flex";
                        deleteContentFieldsForm.style.display = "none";
                        deleteContentSearchForm.reset();
                        loadContents();
                    } else {
                        alert("Error al eliminar el contenido.");
                    }
                } catch {
                    alert("Error al conectar con el servidor.");
                }
            });

            // Cargar contenidos al inicio
            const searchInput = document.getElementById("search-input");
            const sortNameBtn = document.getElementById("sort-name-btn");

            let contenidosGlobal = [];
            let ordenAscendente = true;

            async function loadContents() {
                try {
                    const response = await fetch('/getContenidos');
                    const data = await response.json();
                    contenidosGlobal = data;
                    renderTable(contenidosGlobal);
                } catch (error) {
                    console.error("Error al cargar los contenidos:", error);
                }
            }

            function renderTable(data) {
                contentTableBody.innerHTML = "";
                data.forEach((contenido) => {
                    // Usar solo promocion_activa_porcentaje
                    let promo = contenido.promocion_activa_porcentaje !== null
                        ? contenido.promocion_activa_porcentaje + " %"
                        : "null";
                    const row = document.createElement("tr");
                    row.innerHTML = `
            <td>${contenido.id}</td>
            <td>${contenido.nombre}</td>
            <td>${contenido.autor}</td>
            <td>${contenido.descripcion}</td>
            <td>${contenido.categoria}</td>
            <td>S/ ${parseFloat(contenido.precio).toFixed(2)}</td>
            <td>${promo}</td>
        `;
                    contentTableBody.appendChild(row);
                });
            }

            searchInput.addEventListener("input", () => {
                const search = searchInput.value.trim().toLowerCase();
                const filtrados = contenidosGlobal.filter(c =>
                    c.nombre.toLowerCase().includes(search) ||
                    c.autor.toLowerCase().includes(search)
                );
                renderTable(filtrados);
            });

            sortNameBtn.addEventListener("click", () => {
                ordenAscendente = !ordenAscendente;
                const copia = [...contenidosGlobal];
                copia.sort((a, b) => {
                    if (a.nombre.toLowerCase() < b.nombre.toLowerCase()) return ordenAscendente ? -1 : 1;
                    if (a.nombre.toLowerCase() > b.nombre.toLowerCase()) return ordenAscendente ? 1 : -1;
                    return 0;
                });
                renderTable(copia);
                sortNameBtn.textContent = ordenAscendente ? "Ordenar por Nombre (A-Z)" : "Ordenar por Nombre (Z-A)";
            });

            loadContents();
        });
    </script>
</body>

</html>